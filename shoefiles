#!/bin/bash
###############################################################################
# shoefiles (bash script)
# This script handles installation of shoelick's dotfiles.
###############################################################################

main() {

    echo "Shoelick Dotfiles"
    echo "Updated November '16"

    export DEBUG_OUTPUT=1
    export DOTFILES_REPO_DIR="$( \cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    export DOTFILES_DIR="$HOME/.dotfiles"
    export DOTFILES_BACKUP=
    export SUBCMD=
    export TARGET=
    export PLATFORM=
    export ISGROUP=

    source "$DOTFILES_REPO_DIR/shoes/util.sh"
    source "$DOTFILES_REPO_DIR/shoes/shoes.conf"

    # Debug warning will show if above var is set
    Debug "Debugging is ON! To turn off, unset DEBUG_OUTPUT in shoefiles script."

    RetVal=0;

    #
    # Check args
    #
    Debug "Shoefiles received $@"
    AreArgsValid $@
    RetVal=$?

    # Exit if invalid usage
    [ $RetVal -gt $ERROR_CODE_NONE ] && PrintUsage && return $RetVal;
    
    #
    # Detect Platform
    #
    Debug "Entering platform check." 

    DetectPlatform
    RetVal=$?
    Debug "We are on $PLATFORM"
    # Exit if invalid 
    [ $RetVal -gt $ERROR_CODE_NONE ] && return $RetVal;
    echo "Detected $PLATFORM. Lucky for you, $PLATFORM is supported."

    #
    # Setup / check core
    #
    #source "$DOTFILES_REPO_DIR/core/${PLATFORM}.sh"

    #
    # Configure git
    #
    GIT_EMAIL="$(git config --global user.email)"
    Debug "Git email is: $GIT_EMAIL"
    if [ -z "$GIT_EMAIL" ]; then
        
        Debug "git email not set"
        EMAIL=$(EmailPrompt "Enter a valid email: ")
        DEBUG "Email is: $EMAIL"
        git config --global user.email $EMAIL
    fi

    GIT_USERNAME="$(git config --global user.name)"
    Debug "Git name is: $GIT_USERNAME"
    if [ -z "$GIT_USERNAME" ]; then
        
        Debug "git name not set"
        read -P "Git user name: " INPUT
        Debug "Using $INPUT for git user name"
        git config --global user.name $INPUT
    fi

    #
    # Move dotfiles to final location
    #
    ConfigureDotfilesDir
    RetVal=$?
    [ $RetVal -gt $ERROR_CODE_NONE ] && return $RetVal;

    #
    # Evaluate command
    #

    Debug "Entering command selection majigger"
    ## Execute appropriate action 
    case $SUBCMD in
        "install")
            Debug "Subcommand was $SUBCMD"
            ;;
        "update")
            Debug "Subcommand was $SUBCMD"
            ;;
        "uninstall")
            Debug "Subcommand was $SUBCMD"
            
            ;;
        "test")
            Debug "Subcommand was $SUBCMD"
            ;;
    esac

    return $RetVal


    ## Perform update on dotfiles repo and submodules
    #if [ -d "${DOTFILES_DIR}/.git" ]; then
    #    git --work-tree="${DOTFILES_DIR}" --git-dir="${DOTFILES_DIR}/.git" pull \
    #        --recurse-submodules=yes origin master
    #    git submodule init
    #    git submodule update
    #fi

    ########################################
    ## Perform dotfiles toolbox setup
    ########################################

    ## Package options
    ## Provided packages:

    #if 
    #PACKAGES="zsh neovim"

    ## Source each installation script.
    #for PKG in $PACKAGES; do 
    #    PKG_CONFIG="${DOTFILES_DIR}/packages/${PKG}/config"
    #    source "./packages/${PKG}/${PKG}.sh"
    #    # Source package install script
    #    # All should include definitions for:
    #    # Install, Configure
    #
    #    Install
    #    if [[ $? -eq 0 ]]; then
    #        Configure
    #    else 
    #        echo "ERROR: Installation of $PKG failed."
    #    fi
    #    unset -f Install Configure
    #done    

} 

main $@
cd .
